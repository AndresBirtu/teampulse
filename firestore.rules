rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------- USERS -----------------
    match /users/{userId} {
      // Crear al registrarse
      allow create: if request.auth != null && request.auth.uid == userId;

      // Leer y modificar solo lo suyo
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ----------------- TEAMS -----------------
    match /teams/{teamId} {

      // Cualquiera autenticado puede leer información general del equipo
      allow read: if request.auth != null;

      // Crear equipo → ownerId debe ser UID del entrenador
      allow create: if request.auth != null &&
        request.resource.data.ownerId == request.auth.uid;

      // Actualizar / borrar equipo → owner o cualquier entrenador del equipo
      allow update, delete: if request.auth != null && (
        get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId
        )
      );

      // -------- PLAYERS --------
      match /players/{playerId} {

        // Leer: jugadores y entrenadores del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear:
        // - Entrenador del equipo crea jugadores
        // - Jugador crea su propio doc cuando se añade al equipo
        allow create: if request.auth != null && (
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId
          ) ||
          (
            request.auth.uid == playerId &&
            request.resource.data.role == "jugador" &&
            request.resource.data.teamId == teamId
          )
        );

        // Actualizar / eliminar → solo entrenador del equipo
        allow update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
      }

      // -------- SANCTIONS --------
      match /sanctions/{sanctionId} {

        // Leer → cualquier miembro del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear / actualizar / borrar → entrenadores del equipo
        allow create, update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
      }

      // -------- MATCHES --------
      match /matches/{matchId} {

        // Leer → todos los miembros del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear / editar / borrar → solo entrenador del equipo
        allow write: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // -------- STATS POR PARTIDO --------
        match /stats/{statId} {

          // Leer → jugadores/entrenador del equipo
          allow read: if request.auth != null &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

          // Crear / actualizar / borrar → solo entrenador
          allow create, update, delete: if request.auth != null &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        }

        // -------- DISPONIBILIDAD DE JUGADORES --------
        match /availability/{playerId} {

          // Leer → todos los miembros del equipo pueden ver disponibilidades
          allow read: if request.auth != null &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

          // Escribir → cada jugador solo puede escribir su propia disponibilidad
          allow create, update, delete: if request.auth != null &&
            request.auth.uid == playerId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        }
      }

      // -------- TRAININGS --------
      match /trainings/{trainingId} {

        // Leer → todos los miembros del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear / editar / borrar → solo entrenador del equipo
        allow write: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
      }
    }
  }
}
