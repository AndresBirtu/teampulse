rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------- users -----------------
    match /users/{userId} {
      // Crear al registrarse
      allow create: if request.auth != null && request.auth.uid == userId;

      // Leer y modificar solo lo suyo
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ----------------- teams -----------------
    match /teams/{teamId} {

      // Cualquiera autenticado puede leer info del equipo
      allow read: if request.auth != null;

      // Crear equipo → ownerId debe ser UID del entrenador
      allow create: if request.auth != null &&
        request.resource.data.ownerId == request.auth.uid;

      // Actualizar / borrar equipo → solo owner
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid;


      // -------- players --------
      match /players/{playerId} {

        // Leer: jugadores y entrenadores del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear:
        // - Entrenador del equipo crea jugadores
        // - Jugador crea su doc cuando entra al equipo
        allow create: if request.auth != null && (
            (
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId
            ) ||
            (
              request.auth.uid == playerId &&
              request.resource.data.role == "jugador" &&
              request.resource.data.teamId == teamId
            )
        );

        // Actualizar / eliminar → solo entrenador del equipo
        allow update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
      }


      // -------- matches --------
      match /matches/{matchId} {

        // Leer → todos los miembros del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear / editar / borrar → solo entrenador del equipo
        allow write: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;


        // -------- ESTADÍSTICAS POR PARTIDO --------
        match /stats/{statId} {

          // Leer → jugadores/entrenador del equipo
          allow read: if request.auth != null &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

          // Crear / actualizar / borrar → solo entrenador
          allow create, update, delete: if request.auth != null &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        }

        // -------- DISPONIBILIDAD DE JUGADORES --------
        match /availability/{playerId} {

          // Leer → todos los miembros del equipo pueden ver disponibilidades
          allow read: if request.auth != null &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

          // Escribir → cada jugador solo puede escribir su propia disponibilidad
          allow create, update, delete: if request.auth != null &&
            request.auth.uid == playerId &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        }
      }

      // -------- trainings (entrenamientos) --------
      match /trainings/{trainingId} {

        // Leer → todos los miembros del equipo
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Crear / editar / borrar → solo entrenador del equipo
        allow write: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "entrenador" &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
      }
    }
  }
}
